<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>üìä ƒê·ªçc Excel s·∫£n ph·∫©m</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 40px;
      background: #f9f9f9;
      max-width: 1000px;
      margin: auto;
    }
    h2, h3 {
      color: #333;
    }
    input[type="file"] {
      padding: 10px;
      margin-top: 10px;
    }
    #loading {
      display: none;
      margin-top: 20px;
      font-style: italic;
      color: #555;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 30px;
      background-color: #fff;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
    }
    th, td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: left;
    }
    th {
      background-color: #f1f1f1;
      font-weight: bold;
    }
    #exportBtn {
      margin-top: 20px;
      padding: 10px 20px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #exportBtn:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>

  <h2>üìÇ T·∫£i file Excel s·∫£n ph·∫©m</h2>
  <input type="file" id="inputExcel" accept=".xlsx, .xls" />
  <div id="loading">‚è≥ ƒêang x·ª≠ l√Ω file Excel...</div>
  <button id="exportBtn" style="display:none;">üì• T·∫£i file k·∫øt qu·∫£</button>

  <table id="resultTable" style="display:none;">
    <thead>
      <tr>
        <th>STT</th>
        <th>T√™n s·∫£n ph·∫©m</th>
        <th>L∆∞·ª£t truy c·∫≠p s·∫£n ph·∫©m</th>
        <th>Doanh s·ªë (VND)</th>
        <th>Danh m·ª•c</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h3>B·∫£ng t·ªïng h·ª£p theo d·∫£i s·∫£n ph·∫©m</h3>
  <table id="summaryTable" style="display:none;">
    <thead>
      <tr>
        <th>D·∫£i s·∫£n ph·∫©m</th>
        <th>T·ªïng l∆∞·ª£t truy c·∫≠p</th>
        <th>T·ªïng doanh s·ªë (VND)</th>
        <th>S·ªë kh√°ch h√†ng</th>
        <th>Doanh thu/kh√°ch h√†ng</th>
        <th>T·ª∑ l·ªá chuy·ªÉn ƒë·ªïi</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    let resultData = [];
    const doanhThuTheoKhachHang = {
      'Ch√¢n v√°y (d·∫£i c≈©)': 130000,
      'Ch√¢n v√°y (d·∫£i m·ªõi)': 129000,
      'Qu·∫ßn (d·∫£i m·ªõi)': 159000,
      'Qu·∫ßn (d·∫£i c≈©)': 130000 // gi·∫£ ƒë·ªãnh chung cho d·∫£i c≈© n·∫øu c·∫ßn
    };

    function getDanhMuc(name) {
      const match = name.match(/\b(K[ABC])(\d{2})\b/);
      if (!match) return 'Kh√¥ng x√°c ƒë·ªãnh';

      const type = match[1];
      const num = parseInt(match[2], 10);

      if (type === 'KA') {
        if (num >= 1 && num <= 17) return 'Ch√¢n v√°y (d·∫£i c≈©)';
        if (num >= 18 && num <= 99) return 'Ch√¢n v√°y (d·∫£i m·ªõi)';
      }
      if (type === 'KB') {
        if (num >= 1 && num <= 24) return 'Ch√¢n v√°y (d·∫£i c≈©)';
        if (num >= 25 && num <= 99) return 'Ch√¢n v√°y (d·∫£i m·ªõi)';
      }
      if (type === 'KC') {
        if (num >= 1 && num <= 7) return 'Qu·∫ßn (d·∫£i c≈©)';
        if (num >= 8 && num <= 99) return 'Qu·∫ßn (d·∫£i m·ªõi)';
      }

      return 'Kh√¥ng x√°c ƒë·ªãnh';
    }

    document.getElementById('inputExcel').addEventListener('change', function(e) {
      const file = e.target.files[0];
      const reader = new FileReader();
      document.getElementById('loading').style.display = 'block';

      reader.onload = function(event) {
        const data = new Uint8Array(event.target.result);
        const workbook = XLSX.read(data, { type: 'array' });

        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet);

        const table = document.getElementById('resultTable');
        const tbody = table.querySelector('tbody');
        tbody.innerHTML = '';
        resultData = [];

        const summary = {};

        json.forEach((row, index) => {
          const name = row['S·∫£n ph·∫©m'];
          const views = parseInt(row['L∆∞·ª£t truy c·∫≠p s·∫£n ph·∫©m']) || 0;
          const revenueRaw = row['Doanh s·ªë (ƒê∆°n ƒë√£ x√°c nh·∫≠n) (VND)'];

          let revenue = 0;
          if (typeof revenueRaw === 'string') {
            revenue = Number(revenueRaw.replace(/\./g, '').replace(',', '.'));
          } else if (!isNaN(revenueRaw)) {
            revenue = revenueRaw;
          }

          const danhMuc = getDanhMuc(name);

          if (!summary[danhMuc]) {
            summary[danhMuc] = { views: 0, revenue: 0 };
          }
          summary[danhMuc].views += views;
          summary[danhMuc].revenue += revenue;

          const newRow = {
            STT: index + 1,
            'T√™n s·∫£n ph·∫©m': name,
            'L∆∞·ª£t truy c·∫≠p s·∫£n ph·∫©m': views,
            'Doanh s·ªë (VND)': revenue,
            'Danh m·ª•c': danhMuc
          };
          resultData.push(newRow);

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${newRow.STT}</td>
            <td>${name}</td>
            <td>${views}</td>
            <td>${revenue.toLocaleString('vi-VN')} ƒë</td>
            <td>${danhMuc}</td>
          `;
          tbody.appendChild(tr);
        });

        // T·∫°o b·∫£ng t·ªïng h·ª£p
        const summaryTable = document.getElementById('summaryTable');
        const summaryBody = summaryTable.querySelector('tbody');
        summaryBody.innerHTML = '';

        Object.entries(summary).forEach(([danhMuc, { views, revenue }]) => {
          const dtkh = doanhThuTheoKhachHang[danhMuc] || 1;
          const khach = Math.round(revenue / dtkh);
          const chuyenDoi = views > 0 ? (revenue / dtkh / views * 100).toFixed(2) + '%' : '0%';

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${danhMuc}</td>
            <td>${views}</td>
            <td>${revenue.toLocaleString('vi-VN')} ƒë</td>
            <td>${khach}</td>
            <td>${dtkh.toLocaleString('vi-VN')} ƒë</td>
            <td>${chuyenDoi}</td>
          `;
          summaryBody.appendChild(tr);
        });

        document.getElementById('loading').style.display = 'none';
        table.style.display = 'table';
        summaryTable.style.display = 'table';
        document.getElementById('exportBtn').style.display = 'inline-block';
      };

      reader.readAsArrayBuffer(file);
    });

    document.getElementById('exportBtn').addEventListener('click', function() {
      const ws = XLSX.utils.json_to_sheet(resultData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'K·∫øt qu·∫£');
      XLSX.writeFile(wb, 'ket_qua_phan_loai.xlsx');
    });
  </script>

</body>
</html>
